
---
title: "data_cleaning"
output: pdf_document
date: "2024-10-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{R}
library(readr)
library(tidyverse)
library(stringr)
```

```{R import}
set.seed(123)

players_20_raw <- read_csv("../data/raw_data/players_20.csv")
players_20_raw <- players_20_raw %>% filter(player_positions != "GK")

rows_to_keep <- floor(0.3 * nrow(players_20_raw))
sampled_rows <- sample(1:nrow(players_20_raw), size = rows_to_keep)
player_20_reduced <- players_20_raw[sampled_rows, ]


players_20 <- player_20_reduced |> select(
  short_name,
  age,
  height_cm,
  weight_kg, 
  nationality,
  club,
  overall,
  potential,
  value_eur,
  wage_eur,
  player_positions,
  international_reputation,
  skill_moves,
  body_type,
  release_clause_eur,
  player_tags,
  team_position,
  pace,
  shooting,
  passing,
  dribbling,
  defending,
  physic
)
summary(players_20)

```


```{R}
players_20$Top_country <- ifelse(players_20$nationality %in% c("Belgium", "France", "Brazil","England","Portugal","Spain","Argentina","Uruguay","Mexico"), 
                        "Top_9", 
                        ifelse(players_20$nationality %in% c("Italy", "Croatia","Denmark","Germany","Netherlands","Colombia","Switzerland","Chile","Wales","Poland","Senegal","Sweden"), 
                               "Top_20", 
                               "Other"))


players_20$Top_Club  <- ifelse(players_20$club %in% c("Real Madrid","FC Barcelona","Bayern Munich","AtlÃ©tico Madrid","Juventus","Manchester City","Paris Saint-Germain","Liverpool","Sevilla FC","Arsenal"),"Top_10",
                         ifelse(players_20$club %in% c("Borussia Dortmund","Manchester United","Chelsea FC","FC Porto","Tottenham Hotspur","AS Roma","Napoli","Benfica","Shakhtar Donetsk","Zenit St. Petersburg"),"Top_20","other")
)

```


```{R}

players_20$number_tags_proc <- str_count(players_20$player_tags, ",")
players_20$number_tags <- ifelse(players_20$number_tags_proc == 0,0,players_20$number_tags_proc + 1)

players_20$number_tags_proc <- NULL

players_20$number_tags[is.na(players_20$number_tags)] <- 0

```

```{R}
players_20$player_positions <- sub(",.*","",players_20$player_positions)
```





###overall try fit
```{R}
fit_rating = lm(overall ~ age + value_eur + wage_eur + international_reputation +pace
  + shooting +passing + dribbling + defending + physic, data = players_20)

```

```{R}
fitted_value = fitted(fit_rating)
plot(fitted_value,players_20$overall, xlim=c(50,100))
abline(0, 1, col='blue')
```

```{R}
residual = resid(fit_rating)
plot(fitted_value, residual, xlim=c(50, 85))
plot(fit_rating, which = 2)
```
###try better fit for overall rating
```{R}


fit_rating_improved <- lm(overall ~ age + wage_eur + international_reputation + pace + 
                          shooting + passing + dribbling + physic, data = players_20)
summary(fit_rating_improved)

# Step 3: Introduce interaction terms and polynomial terms
fit_rating_poly <- lm(overall ~ poly(age, 2) + wage_eur * international_reputation + pace +
                      shooting + passing + dribbling + physic, data = players_20)
summary(fit_rating_poly)


```
```{R}
fit_rating_stepwise <- step(fit_rating_poly, direction = "both")
summary(fit_rating_stepwise)

players_20$log_value_eur <- log(players_20$value_eur + 1)
players_20$log_wage_eur <- log(players_20$wage_eur + 1)

fit_rating_log <- lm(overall ~ poly(age, 2) + log_wage_eur * international_reputation + 
                     pace + shooting + passing + dribbling + physic, data = players_20)
summary(fit_rating_log)

```
###try to fit the best model (poly(age, 2))
```{R}
final_data <- players_20 |> select(overall, age, wage_eur, international_reputation, passing, physic)

fit_rating_better = lm(overall ~ age + wage_eur + international_reputation +passing + physic, data = final_data)
fitted_value = fitted(fit_rating_better)
plot(fitted_value,players_20$overall, xlim=c(50,100))
abline(0, 1, col='blue')
residual = resid(fit_rating_better)
plot(fitted_value, residual, xlim=c(50, 100))
plot(fit_rating_better, which = 2)

```
###player value fit
```{R}
fit_value = lm(value_eur ~ overall + age + wage_eur + international_reputation +pace
  + shooting +passing + dribbling + defending + physic, data = players_20)

fitted_value = fitted(fit_value)
plot(fitted_value,players_20$value_eur)
abline(0, 1, col='blue')
```

```{R}
residual = resid(fit_value)
plot(fitted_value, residual, xlim=c(0, 2e7))

```
###Write as csv file in data/cleaned_data
```{r}
write.csv(final_data, "../data/cleaned_data/cleaned_data.csv")
```